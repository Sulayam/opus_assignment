from fastapi import FastAPI, HTTPException  # type: ignore
from models import insert_log, insert_vendor, find_vendor_by_name
from database import init_db
from datetime import datetime

app = FastAPI()

@app.on_event("startup")
def startup():
    init_db()

@app.get("/")
def root():
    return {
        "status": "ok",
        "service": "vendor-backend",
        "endpoints": [
            "/health",
            "/vendor/log",
            "/vendor/create",
            "/vendor/check-duplicate/{vendor_name}"
        ]
    }


@app.get("/health")
def health():
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat()
    }


@app.post("/vendor/log")
async def log_vendor(data: dict):
    insert_log(data)
    return {
        "message": "Log entry recorded",
        "received": data
    }


@app.post("/vendor/create")
async def create_vendor(data: dict):
    """
    Creates a vendor record from the payload generated by Opus Code: Generate Vendor ID.
    """

    required_fields = ["vendor_id", "company_name", "requestor_email"]

    for field in required_fields:
        if field not in data:
            raise HTTPException(status_code=400, detail=f"Missing required field: {field}")

    vendor_name = data["company_name"]
    vendor_id = data["vendor_id"]

    existing = find_vendor_by_name(vendor_name)

    if existing:
        return {
            "message": "Vendor already exists",
            "duplicate": True,
            "existing_vendor": dict(existing)
        }

    vendor_row = {
        "vendor_id": vendor_id,
        "vendor_company_name": vendor_name,
        "requestor_email": data["requestor_email"],
        "country": data.get("country"),
        "annual_spend": data.get("estimated_annual_spend"),
        "payment_terms": data.get("payment_terms_days"),
        "created_at": data.get("timestamp", datetime.utcnow().isoformat())
    }

    insert_vendor(vendor_row)

    return {
        "message": "Vendor created successfully",
        "duplicate": False,
        "vendor": vendor_row
    }


@app.get("/vendor/check-duplicate/{vendor_name}")
def check_duplicate(vendor_name: str):
    existing = find_vendor_by_name(vendor_name)

    if existing:
        return {"duplicate": True, "existing_record": dict(existing)}

    return {"duplicate": False}
